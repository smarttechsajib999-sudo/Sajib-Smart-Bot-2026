name: Sajib_Ultra_Pro_Max_Bot
on:
  workflow_dispatch:

jobs:
  everything:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      
      # ১. সিস্টেম ফাইল এবং পারমিশন ফিক্স (যাতে কোনোদিন আটকাবে না)
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libjpeg-dev zlib1g-dev libpng-dev imagemagick ffmpeg
          # ImageMagick এর পলিসি ফিক্স (যাতে টেক্সট লিখলে এরর না দেয়)
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml

      # ২. লাইব্রেরি ফিক্স (Pillow 9.5.0 দিচ্ছি যা সবথেকে স্টেবল)
      - name: Install Python Libraries & Run
        run: |
          pip install --upgrade pip
          # ঠিক এই ভার্সনটাই লাগবে, অন্যথায় এরর খাবে
          pip install "Pillow==9.5.0" 
          pip install moviepy==1.0.3
          pip install openai edge-tts requests beautifulsoup4 lxml google-api-python-client google-auth-oauthlib

          # মেইন বোট কোড (অটো ফিক্সার সহ)
          cat << 'EOF' > bot.py
          import os, sys
          
          # --- AUTO FIX SECTION START ---
          # বোট নিজেই চেক করবে ANTIALIAS আছে কি না, না থাকলে বানিয়ে নেবে
          import PIL.Image
          if not hasattr(PIL.Image, 'ANTIALIAS'):
              PIL.Image.ANTIALIAS = PIL.Image.LANCZOS
          # --- AUTO FIX SECTION END ---

          import pickle, requests, asyncio
          from openai import OpenAI
          import edge_tts
          from moviepy.editor import VideoFileClip, AudioFileClip
          from bs4 import BeautifulSoup
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          client = OpenAI(api_key="0afdca64-4ba2-4556-ae28-e9f227abecb0", base_url="https://api.sambanova.ai/v1")
          P_KEY = "BjHJTux4O3vjypGJOkerA1DQkj9czukgBQyiYj9OH04hE9EKQp6TJEc5"

          async def run():
              try:
                  print("--- STARTED ---")
                  
                  # 1. Token Check
                  t_file = "token.pickle" if os.path.exists("token.pickle") else "token (1).pickle"
                  if not os.path.exists(t_file): raise Exception("Token file missing!")
                  with open(t_file, 'rb') as t: creds = pickle.load(t)
                  yt = build("youtube", "v3", credentials=creds)

                  # 2. News
                  print("Fetching News...")
                  r = requests.get("https://news.google.com/rss/search?q=latest+tech+gadgets&hl=bn&gl=BD&ceid=BD:bn")
                  soup = BeautifulSoup(r.content, features="xml")
                  items = soup.findAll('item')
                  if not items: raise Exception("Google News returned empty!")
                  topic = items[0].title.text
                  print(f"Topic: {topic}")

                  # 3. Script & Audio
                  print("Generating Audio...")
                  script = client.chat.completions.create(model='Meta-Llama-3.1-8B-Instruct', messages=[{"role": "user", "content": f"Write a 40-sec tech story in Bengali for {topic}"}]).choices[0].message.content
                  await edge_tts.Communicate(script, "bn-BD-PradeepNeural").save("v.mp3")

                  # 4. Video Download
                  print("Downloading Video...")
                  headers = {"Authorization": P_KEY}
                  v_data = requests.get(f"https://api.pexels.com/videos/search?query=technology&orientation=portrait&per_page=1", headers=headers).json()
                  if not v_data.get('videos'): raise Exception("Pexels video not found!")
                  v_url = v_data['videos'][0]['video_files'][0]['link']
                  with open("v.mp4", "wb") as f: f.write(requests.get(v_url).content)

                  # 5. Editing
                  print("Rendering Video...")
                  audio = AudioFileClip("v.mp3")
                  clip = VideoFileClip("v.mp4").resize(height=1920).crop(x1=0, width=1080, height=1920).set_duration(audio.duration).set_audio(audio)
                  clip.write_videofile("f.mp4", codec="libx264", audio_codec="aac", fps=24, logger=None)

                  # 6. Upload
                  print("Uploading to YouTube...")
                  request = yt.videos().insert(
                      part="snippet,status",
                      body={
                          "snippet": {"title": topic[:80], "categoryId": "28"},
                          "status": {"privacyStatus": "public"}
                      },
                      media_body=MediaFileUpload("f.mp4")
                  )
                  response = request.execute()
                  print(f"SUCCESS! Video Link: https://youtu.be/{response['id']}")

              except Exception as e:
                  print(f"\nCRITICAL ERROR: {str(e)}")
                  sys.exit(1)

          if __name__ == "__main__": asyncio.run(run())
          EOF
          
          python bot.py
          
